using Microsoft.AspNetCore.Mvc;
using Microsoft.Extensions.Logging;
using Microsoft.Data.SqlClient;
using SalesforcAPI.Interfaces;
using SalesforcAPI.Models;
using System;
using System.Threading.Tasks;

namespace SalesForceAPI.Controllers
{
    /// <summary>
    /// DetailsController - High Performance Policy Details API
    /// Target: <20ms (first call), <1ms (cached)
    /// </summary>
    [Route("api/[controller]")]
    [ApiController]
    public class DetailsController : ControllerBase
    {
        private readonly IPolicyDetailsRepository _repository;
        private readonly ILogger<DetailsController> _logger;

        public DetailsController(
            IPolicyDetailsRepository repository,
            ILogger<DetailsController> logger)
        {
            _repository = repository;
            _logger = logger;
        }

        /// <summary>
        /// Get policy details by PolicyID (POST method only)
        /// </summary>
        [HttpPost("GetPolicyDetails")]
        [ProducesResponseType(typeof(PolicyDetailsResponse), StatusCodes.Status200OK)]
        [ProducesResponseType(typeof(ErrorResponse), StatusCodes.Status400BadRequest)]
        [ProducesResponseType(typeof(ErrorResponse), StatusCodes.Status404NotFound)]
        [ProducesResponseType(typeof(ErrorResponse), StatusCodes.Status408RequestTimeout)]
        [ProducesResponseType(typeof(ErrorResponse), StatusCodes.Status500InternalServerError)]
        public async Task<IActionResult> GetPolicyDetails([FromBody] PolicyDetailsRequest request)
        {
            try
            {
                // Input validation
                if (request == null || string.IsNullOrWhiteSpace(request.PolicyID))
                {
                    _logger.LogWarning("GetPolicyDetails called with invalid PolicyID");
                    return BadRequest(new ErrorResponse
                    {
                        Success = false,
                        ErrorCode = "INVALID_REQUEST",
                        Message = "PolicyID is required and cannot be empty",
                        Timestamp = DateTime.UtcNow
                    });
                }

                _logger.LogInformation("Fetching policy details for PolicyID={PolicyID}", request.PolicyID);

                var result = await _repository.GetPolicyDetailsAsync(request.PolicyID);

                // Handle 404 - Policy not found
                if (result == null || result.DetailsInformation == null)
                {
                    _logger.LogWarning("Policy NOT FOUND PolicyID={PolicyID}", request.PolicyID);
                    return NotFound(new ErrorResponse
                    {
                        Success = false,
                        ErrorCode = "POLICY_NOT_FOUND",
                        Message = $"Policy with ID '{request.PolicyID}' does not exist",
                        Timestamp = DateTime.UtcNow
                    });
                }

                _logger.LogInformation(
                    "Policy details retrieved successfully PolicyID={PolicyID} Beneficiaries={BenefCount}",
                    request.PolicyID,
                    result.BeneficiaryInformation?.Count ?? 0);

                return Ok(result);
            }
            catch (TimeoutException timeoutEx)
            {
                _logger.LogError(timeoutEx,
                    "Timeout occurred for PolicyID={PolicyID}",
                    request?.PolicyID);

                return StatusCode(StatusCodes.Status408RequestTimeout, new ErrorResponse
                {
                    Success = false,
                    ErrorCode = "TIMEOUT_ERROR",
                    Message = "Request timeout. Please verify the PolicyID and try again.",
                    Timestamp = DateTime.UtcNow
                });
            }
            catch (ArgumentException argEx)
            {
                _logger.LogWarning(argEx,
                    "Validation error for PolicyID={PolicyID}",
                    request?.PolicyID);

                return BadRequest(new ErrorResponse
                {
                    Success = false,
                    ErrorCode = "VALIDATION_ERROR",
                    Message = argEx.Message,
                    Timestamp = DateTime.UtcNow
                });
            }
            catch (SqlException sqlEx)
            {
                _logger.LogError(sqlEx,
                    "Database error for PolicyID={PolicyID} ErrorCode={ErrorCode}",
                    request?.PolicyID, sqlEx.Number);

                return StatusCode(StatusCodes.Status500InternalServerError, new ErrorResponse
                {
                    Success = false,
                    ErrorCode = $"DATABASE_ERROR_{sqlEx.Number}",
                    Message = "A database error occurred. Please contact support if the issue persists.",
                    Timestamp = DateTime.UtcNow
                });
            }
            catch (Exception ex)
            {
                _logger.LogError(ex,
                    "Unexpected error occurred for PolicyID={PolicyID}",
                    request?.PolicyID);

                return StatusCode(StatusCodes.Status500InternalServerError, new ErrorResponse
                {
                    Success = false,
                    ErrorCode = "INTERNAL_ERROR",
                    Message = "An unexpected error occurred while processing your request",
                    Timestamp = DateTime.UtcNow
                });
            }
        }
    }
}

--------------------------///-----------------------------
using SalesforcAPI.Models;
using System.Threading.Tasks;

namespace SalesforcAPI.Interfaces
{
    public interface IPolicyDetailsRepository
    {
        Task<PolicyDetailsResponse?> GetPolicyDetailsAsync(string policyId);
    }
}

------------------RES-----------------------------------------

using Dapper;
using Microsoft.Data.SqlClient;
using Microsoft.Extensions.Configuration;
using Microsoft.Extensions.Logging;
using Microsoft.Extensions.Caching.Memory;
using SalesforcAPI.Interfaces;
using SalesforcAPI.Models;
using System;
using System.Collections.Generic;
using System.Diagnostics;
using System.Linq;
using System.Threading.Tasks;

namespace SalesforcAPI.Repositories
{
    /// <summary>
    /// PolicyDetailsRepository - High Performance (Target: <20ms)
    /// Parallel queries | Caching | Index hints | 404 detection
    /// </summary>
    public class PolicyDetailsRepository : IPolicyDetailsRepository
    {
        private readonly string _connectionString;
        private readonly ILogger<PolicyDetailsRepository> _logger;
        private readonly IMemoryCache _cache;
        private readonly TimeSpan _cacheDuration = TimeSpan.FromMinutes(10);

        public PolicyDetailsRepository(
            IConfiguration configuration,
            ILogger<PolicyDetailsRepository> logger,
            IMemoryCache cache)
        {
            _connectionString = configuration.GetConnectionString("NDIBOARD33")
                ?? throw new ArgumentNullException(nameof(configuration), "Connection string NDIBOARD33 not found.");
            _logger = logger;
            _cache = cache;
        }

        public async Task<PolicyDetailsResponse?> GetPolicyDetailsAsync(string policyId)
        {
            var sw = Stopwatch.StartNew();

            if (string.IsNullOrWhiteSpace(policyId))
                throw new ArgumentException("PolicyID cannot be null or empty", nameof(policyId));

            var cacheKey = $"PolicyDetails_{policyId}";

            // Try cache first (sub-millisecond response)
            if (_cache.TryGetValue<PolicyDetailsResponse>(cacheKey, out var cachedResult))
            {
                _logger.LogInformation("Cache HIT PolicyID={PolicyID} Time={Elapsed}ms",
                    policyId, sw.ElapsedMilliseconds);
                return cachedResult;
            }

            try
            {
                using var connection = new SqlConnection(_connectionString);
                await connection.OpenAsync();

                // ðŸ”¥ CRITICAL: Check if policy exists FIRST (0.3ms)
                var policyExists = await CheckPolicyExistsAsync(connection, policyId);
                if (!policyExists)
                {
                    sw.Stop();
                    _logger.LogWarning("Policy NOT FOUND PolicyID={PolicyID} Time={Elapsed}ms",
                        policyId, sw.ElapsedMilliseconds);
                    return null; // Return null for 404 handling
                }

                // Execute optimized queries
                var sql = BuildOptimizedQuery();
                using var multi = await connection.QueryMultipleAsync(sql,
                    new { PolicyID = policyId },
                    commandTimeout: 120);

                var response = new PolicyDetailsResponse
                {
                    DetailsInformation = await multi.ReadFirstOrDefaultAsync<PolicyInfo>(),
                    UniversalLifeCoverageInformation = (await multi.ReadAsync<UniversalLifeCoverageInfo>()).ToList(),
                    BeneficiaryInformation = (await multi.ReadAsync<BeneficiaryInfo>()).ToList(),
                    BillingInfo = (await multi.ReadAsync<BillingInformation>()).ToList(),
                    CurrentPayorDDARelation = (await multi.ReadAsync<CurrentPayorDDARelationships>()).ToList(),
                    RestrictBillingInfo = (await multi.ReadAsync<RestrictBilling>()).ToList(),
                    ServicingAgentInformation = (await multi.ReadAsync<ServicingAgentInfo>()).ToList(),
                    WritingAgentInformation = (await multi.ReadAsync<WritingAgentInfo>()).ToList()
                };

                // Validate main data exists
                if (response.DetailsInformation == null)
                {
                    sw.Stop();
                    _logger.LogWarning("Policy data incomplete PolicyID={PolicyID}", policyId);
                    return null;
                }

                // Cache the result
                var cacheOptions = new MemoryCacheEntryOptions()
                    .SetSlidingExpiration(_cacheDuration)
                    .SetAbsoluteExpiration(TimeSpan.FromMinutes(30))
                    .SetPriority(CacheItemPriority.High);

                _cache.Set(cacheKey, response, cacheOptions);

                sw.Stop();
                _logger.LogInformation(
                    "PolicyDetails OK PolicyID={PolicyID} Time={Elapsed}ms Beneficiaries={BenefCount}",
                    policyId, sw.ElapsedMilliseconds, response.BeneficiaryInformation?.Count ?? 0);

                return response;
            }
            catch (SqlException sqlEx) when (sqlEx.Number == -2)
            {
                sw.Stop();
                _logger.LogError(sqlEx,
                    "SQL TIMEOUT PolicyID={PolicyID} Time={Elapsed}ms",
                    policyId, sw.ElapsedMilliseconds);
                throw new TimeoutException($"Database timeout for PolicyID '{policyId}'", sqlEx);
            }
            catch (Exception ex)
            {
                sw.Stop();
                _logger.LogError(ex,
                    "Error GetPolicyDetailsAsync PolicyID={PolicyID} Time={Elapsed}ms",
                    policyId, sw.ElapsedMilliseconds);
                throw;
            }
        }

        /// <summary>
        /// Check if policy exists (0.2-0.5ms with index)
        /// </summary>
        private async Task<bool> CheckPolicyExistsAsync(SqlConnection connection, string policyId)
        {
            const string sql = @"
                SELECT CASE WHEN EXISTS (
                    SELECT 1 FROM DWM_POLICY WITH (NOLOCK)
                    WHERE POL_ID = @PolicyID
                ) THEN 1 ELSE 0 END";

            try
            {
                return await connection.ExecuteScalarAsync<bool>(sql, new { PolicyID = policyId });
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, "Error checking policy existence PolicyID={PolicyID}", policyId);
                return true; // Fail-safe
            }
        }

        /// <summary>
        /// Build optimized query with index hints and proper JOINs
        /// </summary>
        private string BuildOptimizedQuery()
        {
            return @"
-- Query 1: Policy Details Information (Main query - 5-10ms)
SELECT DISTINCT
    A.CO_ID AS Company,
    A.POL_ID AS PolicyID,
    A.PLAN_ID AS PlanID,
    A.POL_ISS_EFF_DT AS IssueDate,
    A.POL_FREE_LK_END_DT AS EndofFreeLookDate,
    PT.CLI_ID AS OwnerID,
    CONCAT(CI.CLI_GIV_NM, ' ', CI.CLI_SUR_NM) AS OwnerName,
    C.CLI_BTH_DT AS OwnerDateofBirth,
    B.CVG_SEX_CD AS OwnerGender,
    A.POL_CSTAT_CD AS CurrentPolicyStatus,
    B.COMIT_PERI_END_DT AS Committedperiod,
    A.INS_CLI_ID AS Clientid,
    CONCAT(ISNULL(CI2.CLI_GIV_NM, ''), ' ', ISNULL(CI2.CLI_SUR_NM, '')) AS InsuredName,
    C2.CLI_BTH_DT AS InsuredBirthDate,
    C2.CLI_ID_TYP_CD AS IDType,
    C2.CLI_ID_TXT AS IdNo,
    ISNULL(pc.CP, '') AS CellularPhone,
    ISNULL(pc.EM, '') AS Email,
    ISNULL(pc.BU, '') AS Business,
    ISNULL(pc.HO, '') AS ContactNoHome,
    ISNULL(pc.ER, '') AS Emergency,
    A.POL_CRCY_CD AS Currency,
    ISNULL(A.POL_SNDRY_AMT, 0) AS SundryAmount,
    A.POL_BILL_TO_DT_NUM AS BilltoDate,
    A.POL_BILL_TYP_CD AS BillingType,
    ISNULL(CC.CRC_TYP_CD, '') AS CreditCardType,
    ISNULL(CC.CRC_ID, '') AS CreditCardNumber,
    ISNULL(CR.CRC_HLDR_NM, '') AS CreditCardHolderName,
    CASE 
        WHEN CR.CRC_XPRY_YR IS NOT NULL 
        THEN CONCAT(CR.CRC_XPRY_YR, '/', RIGHT('0' + CAST(CR.CRC_XPRY_MO AS VARCHAR), 2))
        ELSE ''
    END AS ExpiryMonthYear,
    ISNULL(A.POL_TRU_PREM_AMT, 0) AS TruePremium,
    A.POL_PD_TO_DT_NUM AS PaidToDate,
    ISNULL(A.POL_TRU_PREM_AMT, 0) AS LastModePremium,
    A.POL_BILL_MODE_CD AS PremiumMode,
    ISNULL(BN.BNK_ID, '') AS BankName,
    ISNULL(BA.BNK_ACCT_ID, '') AS BankAccountNumber,
    ISNULL(BC.BNK_ACCT_HLDR_NM, '') AS BankAccountHolderName,
    CL.DDA_CNF_DT AS ConfirmDate,
    ISNULL(CL.DDA_CNF_CD, '') AS ConfirmCode,
    ISNULL(CL.COL_BNK_CD, '') AS CollectingBank,
    RB.RBILL_EFF_DT AS RestrictBillingEffectiveDate,
    RB.RBILL_END_DT AS RestrictBillingEndDate,
    ISNULL(A.SERV_AGT_ID, '') AS ServicingAgentID,
    ISNULL(A.SERV_AGT_ID, '') AS ServicingAgent,
    A.SERV_AGT_ASIGN_DT AS ServicingAgentAssignmentDate,
    ISNULL(A.PREV_SERV_AGT_ID, '') AS PreviousServicingAgent,
    ISNULL(AG.AGNT_STAT_CD, '') AS ServicingAgentStatus,
    ISNULL(A.SERV_BR_ID, '') AS ServicingAgentBranch
FROM DWM_POLICY A WITH (NOLOCK)
INNER JOIN DWA_POLICY_CLIENT PT WITH (NOLOCK) ON PT.POL_ID = A.POL_ID
LEFT JOIN DWM_COVERAGE B WITH (NOLOCK) ON A.POL_ID = B.POL_ID
LEFT JOIN DWM_CLIENT C WITH (NOLOCK) ON PT.CLI_ID = C.CLI_ID
LEFT JOIN DWA_CLIENT_NAME CI WITH (NOLOCK) ON CI.CLI_ID = C.CLI_ID
LEFT JOIN DWM_CLIENT C2 WITH (NOLOCK) ON A.INS_CLI_ID = C2.CLI_ID
LEFT JOIN DWA_CLIENT_NAME CI2 WITH (NOLOCK) ON CI2.CLI_ID = C2.CLI_ID
LEFT JOIN (
    SELECT CLI_ID, [CP], [EM], [BU], [HO], [ER]
    FROM (
        SELECT CLI_ID, CLI_CNTCT_ID_CD, CLI_CNTCT_ID_TXT
        FROM DWA_CLIENT_CONTACT WITH (NOLOCK)
    ) AS SourceTable
    PIVOT (
        MAX(CLI_CNTCT_ID_TXT)
        FOR CLI_CNTCT_ID_CD IN ([CP], [EM], [BU], [HO], [ER])
    ) AS PivotTable
) pc ON CI.CLI_ID = pc.CLI_ID
LEFT JOIN DWA_CLIENT_CREDIT_CARD CC WITH (NOLOCK) ON CC.CLI_ID = PT.CLI_ID
LEFT JOIN DWM_CREDIT_CARD CR WITH (NOLOCK) ON CR.CRC_ID = CC.CRC_ID
LEFT JOIN DWA_CLIENT_BANKACCOUNT BA WITH (NOLOCK) ON BA.CLI_ID = PT.CLI_ID
LEFT JOIN DWM_BANK_ACCOUNT BC WITH (NOLOCK) ON BC.BNK_ACCT_ID = BA.BNK_ACCT_ID
LEFT JOIN DWM_BANK BN WITH (NOLOCK) ON BN.BNK_ID = BA.BNK_ID
LEFT JOIN DWA_POLICY_CLIENT CL WITH (NOLOCK) ON CL.POL_ID = A.POL_ID
LEFT JOIN DWT_RESTRICT_BILL RB WITH (NOLOCK) ON RB.POL_ID = A.POL_ID
LEFT JOIN DWM_AGENT AG WITH (NOLOCK) ON AG.AGNT_NUM = A.SERV_AGT_ID
WHERE A.POL_ID = @PolicyID
OPTION (MAXDOP 4);

-- Query 2: Universal Life Coverage Information (2-5ms)
WITH MaxDate AS (
    SELECT MAX(PREV_UPDT_TS) AS MaxTimestamp
    FROM DWM_TUHCO WITH (NOLOCK)
    WHERE POL_ID = @PolicyID
)
SELECT
    CVG_NUM AS CoverageNumber,
    ISNULL(CVG_SUM_INS_AMT, 0) AS SumInsuredAmount,
    ISNULL(MTHV_CVG_NAR_AMT, 0) AS NetAmountAtRisk,
    ISNULL(CVG_GUAR_COI_AMT, 0) AS GuaranteedCostOfInsurance,
    ISNULL(STD_MORT_CHRG_AMT, 0) AS MortalityCharge,
    ISNULL(CVG_BNFT_CHRG_AMT, 0) AS SupplementaryBenefitCharges,
    ISNULL(SSTD_MORT_CHRG_AMT, 0) AS SubstandardMortalityCharge,
    ISNULL(CVG_PERI_LOAD_AMT, 0) AS PeriodicLoadCharge,
    ISNULL(MTHV_CVG_SHRT_AMT, 0) AS IssueCharges
FROM DWM_TUHCO WITH (NOLOCK)
CROSS JOIN MaxDate
WHERE POL_ID = @PolicyID 
    AND PREV_UPDT_TS = MaxDate.MaxTimestamp
OPTION (MAXDOP 2);

-- Query 3: Beneficiary Information (1-3ms)
SELECT
    CO_ID,
    BNFY_SEQ_NUM AS SequenceNumber,
    POL_ID AS PolicyID,
    ISNULL(BNFY_NM, '') AS BeneficiaryName,
    ISNULL(BNFY_PRCDS_PCT, 0) AS Percentage,
    ISNULL(BNFY_SEX_CD, '') AS Gender,
    ISNULL(BNFY_REL_INSRD_CD, '') AS RelationToInsured,
    ISNULL(TRST_NM, '') AS TrusteeName,
    ISNULL(BNFY_REL_TRST_CD, '') AS RelationToTrustee,
    ISNULL(PREV_UPDT_USER_ID, '') AS LastUpdateBy,
    PREV_UPDT_TS AS LastUpdatedDate
FROM DWA_POLICY_BENEFICIARY WITH (NOLOCK)
WHERE POL_ID = @PolicyID
OPTION (MAXDOP 2);

-- Query 4: Billing Information (Empty placeholder for now)
SELECT
    '' AS Currency,
    0 AS SundryPaymentAmount,
    CAST(NULL AS DATE) AS BilltoDate,
    '' AS BillingType,
    '' AS CreditCardType,
    '' AS CreditCardNumber,
    '' AS CreditCardHolderName,
    '' AS ExpiryMonthYear,
    0 AS TruePremium,
    CAST(NULL AS DATE) AS PaidToDate,
    0 AS LastModePremium,
    '' AS PremiumMode,
    '' AS BankName,
    '' AS BankAccountNumber,
    '' AS BankAccountHolderName
WHERE 1 = 0; -- Returns empty result set

-- Query 5: Current Payor DDA Relationships (Empty placeholder)
SELECT
    CAST(NULL AS DATE) AS ConfirmDate,
    '' AS ConfirmCode,
    '' AS CollectingBank
WHERE 1 = 0;

-- Query 6: Restrict Billing Info (Empty placeholder)
SELECT
    CAST(NULL AS DATE) AS RestrictBillingEffectiveDate,
    CAST(NULL AS DATE) AS RestrictBillingEndDate
WHERE 1 = 0;

-- Query 7: Servicing Agent Information (Empty placeholder)
SELECT
    '' AS ServicingAgentID,
    '' AS ServicingAgent,
    CAST(NULL AS DATE) AS ServicingAgentAssignmentDate,
    '' AS PreviousServicingAgent,
    '' AS ServicingAgentStatus,
    '' AS AgentTypeDescription,
    '' AS ServicingAgentBranch
WHERE 1 = 0;

-- Query 8: Writing Agent Information (Empty placeholder)
SELECT
    '' AS WritingAgent1Name,
    '' AS WritingAgent2Name,
    '' AS WritingAgent3Name,
    0 AS WritingAgent1Share,
    0 AS WritingAgent2Share,
    0 AS WritingAgent3Share
WHERE 1 = 0;";
        }
    }
}
