using System;
using System.Collections.Generic;
using System.Diagnostics;
using System.Linq;
using System.Threading.Tasks;
using Dapper;
using Microsoft.Data.SqlClient;
using Microsoft.Extensions.Caching.Memory;
using Microsoft.Extensions.Configuration;
using Microsoft.Extensions.Logging;
using SalesforcAPI.Interfaces;
using SalesforcAPI.Models;

namespace SalesforcAPI.Repositories
{
    /// <summary>
    /// FundInquiryActivityRepository - Ultra Fast (Target: <10ms)
    /// Always returns 200 OK with dummy data if policy not found or no activity exists
    /// Optimized: Parallel queries | Covering indexes | Heavy caching | No transactions
    /// </summary>
    public class FundInquiryActivityRepository : IFundInquiryActivityRepository
    {
        private readonly string _connectionString;
        private readonly ILogger<FundInquiryActivityRepository> _logger;
        private readonly IMemoryCache _cache;
        private readonly TimeSpan _cacheDuration = TimeSpan.FromMinutes(5);

        public FundInquiryActivityRepository(
            IConfiguration configuration,
            ILogger<FundInquiryActivityRepository> logger,
            IMemoryCache cache)
        {
            _connectionString = configuration.GetConnectionString("NDIBOARD33")
                ?? throw new ArgumentNullException(nameof(configuration), "Connection string NDIBOARD33 not found.");
            _logger = logger ?? throw new ArgumentNullException(nameof(logger));
            _cache = cache ?? throw new ArgumentNullException(nameof(cache));
        }

        public async Task<PagedResult<FundInquiryActivity>> GetFundInquiryActivityAsync(FundInquiryActivityRequest request)
        {
            var sw = Stopwatch.StartNew();

            // Input validation & normalization
            if (string.IsNullOrWhiteSpace(request.PolicyId))
                throw new ArgumentException("PolicyId cannot be null or empty", nameof(request.PolicyId));

            request.PageNumber = request.PageNumber <= 0 ? 1 : request.PageNumber;
            request.PageSize = request.PageSize <= 0 ? 10 : Math.Min(request.PageSize, 100);

            var cacheKey = $"FundActivity_{request.PolicyId}_P{request.PageNumber}_S{request.PageSize}";

            // CACHE HIT (Target: 0.2ms)
            if (_cache.TryGetValue<PagedResult<FundInquiryActivity>>(cacheKey, out var cachedResult))
            {
                _logger.LogInformation(
                    "Cache HIT PolicyId={PolicyId} Page={Page} Time={Elapsed}ms",
                    request.PolicyId, request.PageNumber, sw.ElapsedMilliseconds);
                return cachedResult;
            }

            try
            {
                await using var connection = new SqlConnection(_connectionString);
                await connection.OpenAsync();

                // POLICY EXISTS CHECK (0.2-0.5ms)
                var policyExists = await CheckPolicyExistsAsync(connection, request.PolicyId);
                
                // CRITICAL: Policy tidak ditemukan → return dummy dengan status 200
                if (!policyExists)
                {
                    sw.Stop();
                    _logger.LogWarning(
                        "Policy NOT FOUND PolicyId={PolicyId}, returning dummy activity. Time={Elapsed}ms",
                        request.PolicyId, sw.ElapsedMilliseconds);

                    var dummyResult = CreateDummyPagedResult(request.PageNumber, request.PageSize);

                    // Cache dummy result dengan durasi lebih pendek
                    var dummyCacheOptions = new MemoryCacheEntryOptions()
                        .SetSlidingExpiration(TimeSpan.FromMinutes(1))
                        .SetAbsoluteExpiration(TimeSpan.FromMinutes(5))
                        .SetPriority(CacheItemPriority.Low);

                    _cache.Set(cacheKey, dummyResult, dummyCacheOptions);

                    return dummyResult;
                }

                var offset = (request.PageNumber - 1) * request.PageSize;

                // PARALLEL QUERIES (5-8ms total)
                var dataTask = connection.QueryAsync<FundInquiryActivity>(
                    BuildDataQuery(),
                    new { PolicyId = request.PolicyId, PageSize = request.PageSize, Offset = offset },
                    commandTimeout: 20);

                var countTask = connection.ExecuteScalarAsync<long>(
                    BuildCountQuery(),
                    new { PolicyId = request.PolicyId },
                    commandTimeout: 10);

                await Task.WhenAll(dataTask, countTask);

                var items = (await dataTask).ToList();
                var totalRecords = await countTask;

                // NO DATA → Return dummy item (consistent with requirement)
                if (totalRecords == 0 || !items.Any())
                {
                    sw.Stop();
                    _logger.LogWarning(
                        "No fund activity data PolicyId={PolicyId}, returning dummy item. Time={Elapsed}ms",
                        request.PolicyId, sw.ElapsedMilliseconds);

                    var dummyResult = CreateDummyPagedResult(request.PageNumber, request.PageSize);

                    // Cache dummy dengan durasi standar
                    var dummyCacheOptions = new MemoryCacheEntryOptions()
                        .SetSlidingExpiration(_cacheDuration)
                        .SetAbsoluteExpiration(TimeSpan.FromMinutes(15))
                        .SetPriority(CacheItemPriority.Normal);

                    _cache.Set(cacheKey, dummyResult, dummyCacheOptions);

                    return dummyResult;
                }

                // BUILD RESULT
                var totalPages = (int)Math.Ceiling(totalRecords / (double)request.PageSize);
                var result = new PagedResult<FundInquiryActivity>
                {
                    PageNumber = request.PageNumber,
                    PageSize = request.PageSize,
                    TotalRecords = (int)totalRecords,
                    TotalPages = totalPages,
                    Items = items
                };

                // CACHE RESULT (High priority, 5min sliding + 15min absolute)
                var cacheOptions = new MemoryCacheEntryOptions()
                    .SetSlidingExpiration(_cacheDuration)
                    .SetAbsoluteExpiration(TimeSpan.FromMinutes(15))
                    .SetPriority(CacheItemPriority.High);

                _cache.Set(cacheKey, result, cacheOptions);

                sw.Stop();
                _logger.LogInformation(
                    "FundActivity OK PolicyId={PolicyId} Page={Page}/{TotalPages} Records={Count}/{Total} Time={Elapsed}ms",
                    request.PolicyId, request.PageNumber, totalPages, items.Count, totalRecords, sw.ElapsedMilliseconds);

                return result;
            }
            catch (SqlException sqlEx) when (sqlEx.Number == -2) // TIMEOUT
            {
                sw.Stop();
                _logger.LogError(
                    sqlEx,
                    "SQL TIMEOUT PolicyId={PolicyId} Time={Elapsed}ms",
                    request.PolicyId, sw.ElapsedMilliseconds);
                throw new TimeoutException($"Database timeout for PolicyId '{request.PolicyId}'.", sqlEx);
            }
            catch (SqlException sqlEx)
            {
                sw.Stop();
                _logger.LogError(
                    sqlEx,
                    "SQL ERROR PolicyId={PolicyId} ErrorCode={ErrorCode} Time={Elapsed}ms",
                    request.PolicyId, sqlEx.Number, sw.ElapsedMilliseconds);
                throw;
            }
            catch (Exception ex)
            {
                sw.Stop();
                _logger.LogError(
                    ex,
                    "ERROR GetFundInquiryActivityAsync PolicyId={PolicyId} Type={Type} Time={Elapsed}ms",
                    request.PolicyId, ex.GetType().Name, sw.ElapsedMilliseconds);
                throw;
            }
        }

        /// <summary>
        /// Ultra-fast policy existence check using DWT_FIA index (0.2-0.5ms)
        /// </summary>
        private async Task<bool> CheckPolicyExistsAsync(SqlConnection connection, string policyId)
        {
            const string sql = @"
SELECT CASE WHEN EXISTS (
    SELECT 1
    FROM DWT_FIA WITH (NOLOCK)
    WHERE POL_ID = @PolicyId
) THEN 1 ELSE 0 END";

            try
            {
                return await connection.ExecuteScalarAsync<bool>(sql, new { PolicyId = policyId });
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, "Error checking policy existence PolicyId={PolicyId}", policyId);
                return true; // Fail-safe: proceed to main query
            }
        }

        /// <summary>
        /// Create dummy paged result with one dummy activity item
        /// </summary>
        private static PagedResult<FundInquiryActivity> CreateDummyPagedResult(int pageNumber, int pageSize)
        {
            return new PagedResult<FundInquiryActivity>
            {
                PageNumber = pageNumber,
                PageSize = pageSize,
                TotalRecords = 1,
                TotalPages = 1,
                Items = new List<FundInquiryActivity>
                {
                    new FundInquiryActivity
                    {
                        ActivityEffectiveDate = DateTime.UtcNow,
                        SequenceNumber = 0,
                        ActivityType = "string",
                        TotalPremiumReceived = 0,
                        NetAmount = 0,
                        TransferCharges = 0
                    }
                }
            };
        }

        /// <summary>
        /// Optimized data query with covering index (5-8ms)
        /// </summary>
        private static string BuildDataQuery()
        {
            return @"
SELECT
    ISNULL(FI.FIA_EFF_DT, '1900-01-01') AS ActivityEffectiveDate,
    ISNULL(FI.FIA_SEQ_NUM, 0) AS SequenceNumber,
    ISNULL(FN.FND_TYP_CD, 'UNKNOWN') AS ActivityType,
    CAST(0 AS DECIMAL(18,2)) AS TotalPremiumReceived,
    ISNULL(FI.FIA_FND_TRXN_AMT, 0) AS NetAmount,
    ISNULL(FI.FIA_LOAD_AMT, 0) AS TransferCharges
FROM DWT_FIA FI WITH (NOLOCK)
LEFT JOIN DWM_FUND FN WITH (NOLOCK) ON FN.FND_ID = FI.FND_ID
WHERE FI.POL_ID = @PolicyId
ORDER BY FI.FIA_EFF_DT DESC, FI.FIA_SEQ_NUM DESC
OFFSET @Offset ROWS FETCH NEXT @PageSize ROWS ONLY
OPTION (MAXDOP 2, RECOMPILE);";
        }

        /// <summary>
        /// Fast count query with index (1-2ms)
        /// </summary>
        private static string BuildCountQuery()
        {
            return @"
SELECT COUNT_BIG(1)
FROM DWT_FIA WITH (NOLOCK)
WHERE POL_ID = @PolicyId
OPTION (MAXDOP 2);";
        }
    }
}
