import { Injectable } from '@angular/core';
import { HttpClient, HttpParams } from '@angular/common/http';
import { Observable } from 'rxjs';

export interface ConsolidatePolicy {
  companyID: string;
  policyID: string;
  appNo: string;
  ownerName: string;
  issuedDate: string; // atau Date kalau mau di-convert
}

// Sesuaikan dengan JSON dari C#.
// Kalau C# pakai default System.Text.Json (camelCase), JSON akan:
// { "data": [...], "totalRecords": 22, "pageNumber": 1, "pageSize": 10, "totalPages": 3 }
export interface PagedResult<T> {
  data: T[];
  totalRecords: number;
  pageNumber: number;
  pageSize: number;
  totalPages: number;
}

@Injectable({
  providedIn: 'root'
})
export class PolicyService {
  private apiUrl = 'https://localhost:7147/api';

  constructor(private http: HttpClient) {}

  getConsolidatePolicy(
    policyId: string | undefined,
    appNo: string | undefined,
    pageNumber: number,
    pageSize: number
  ): Observable<PagedResult<ConsolidatePolicy>> {

    let params = new HttpParams()
      .set('pageNumber', pageNumber)
      .set('pageSize', pageSize);

    if (policyId) {
      params = params.set('policyId', policyId);
    }
    if (appNo) {
      params = params.set('appNo', appNo);
    }

    return this.http.get<PagedResult<ConsolidatePolicy>>(
      `${this.apiUrl}/policy/consolidate`,
      { params }
    );
  }

  getPolicyDetail(policyId: string): Observable<any> {
    return this.http.get<any>(`${this.apiUrl}/policy/detail/${policyId}`);
  }
}



ts


import { Component, OnInit } from '@angular/core';
import { FormBuilder, FormGroup } from '@angular/forms';
import { Router } from '@angular/router';
import { DatePipe } from '@angular/common';
import { PolicyService, ConsolidatePolicy, PagedResult } from '../services/policy.service';

@Component({
  selector: 'app-consolidate-policy',
  standalone: false,
  templateUrl: './consolidate-policy.component.html',
  styleUrls: ['./consolidate-policy.component.scss']
})
export class ConsolidatePolicyComponent implements OnInit {
  searchForm: FormGroup;
  policies: ConsolidatePolicy[] = [];

  currentPage = 1;
  pageSize = 10;
  totalCount = 0;
  totalPages = 0;

  isLoading = false;

  constructor(
    private formBuilder: FormBuilder,
    private policyService: PolicyService,
    private router: Router,
    private datePipe: DatePipe
  ) {
    this.searchForm = this.formBuilder.group({
      policyId: [''],
      appNo: ['']
    });
  }

  ngOnInit(): void {
    this.loadData();
  }

  trackByPolicyId(index: number, item: ConsolidatePolicy): any {
    return item.policyID || index;
  }

  loadData(): void {
    this.isLoading = true;

    const formValues = this.searchForm.value;

    this.policyService.getConsolidatePolicy(
      formValues.policyId || undefined,
      formValues.appNo || undefined,
      this.currentPage,
      this.pageSize
    ).subscribe({
      next: (response: PagedResult<ConsolidatePolicy>) => {
        console.log('API Response:', response);

        // Jika interface PagedResult pakai camelCase:
        this.policies   = response.data;
        this.totalCount = response.totalRecords;
        this.totalPages = response.totalPages;

        // Jika Anda ganti PagedResult ke PascalCase (Data, TotalRecords, TotalPages),
        // gunakan baris berikut sebagai ganti:
        // this.policies   = response.Data;
        // this.totalCount = response.TotalRecords;
        // this.totalPages = response.TotalPages;

        console.log('Pagination:', {
          currentPage: this.currentPage,
          totalPages: this.totalPages,
          totalCount: this.totalCount,
          pageNumbers: this.getPageNumbers()
        });

        this.isLoading = false;
      },
      error: (error) => {
        console.error('Error loading data:', error);
        this.policies = [];
        this.totalCount = 0;
        this.totalPages = 0;
        this.isLoading = false;
      }
    });
  }

  onSearch(): void {
    this.currentPage = 1;
    this.loadData();
  }

  onReset(): void {
    this.searchForm.reset();
    this.currentPage = 1;
    this.loadData();
  }

  onPageSizeChange(): void {
    this.currentPage = 1;
    this.loadData();
  }

  getPageNumbers(): number[] {
    const pages: number[] = [];

    if (this.totalPages < 1) {
      return pages;
    }

    const maxVisible = 5;
    let startPage = Math.max(1, this.currentPage - Math.floor(maxVisible / 2));
    let endPage   = Math.min(this.totalPages, startPage + maxVisible - 1);

    if (endPage - startPage + 1 < maxVisible) {
      startPage = Math.max(1, endPage - maxVisible + 1);
    }

    for (let i = startPage; i <= endPage; i++) {
      pages.push(i);
    }

    return pages;
  }

  goToPage(page: number): void {
    if (page >= 1 && page <= this.totalPages && page !== this.currentPage) {
      this.currentPage = page;
      this.loadData();
    }
  }

  viewPolicyDetail(policyId: string): void {
    this.router.navigate(['/policy-detail', policyId]);
  }

  formatDate(date: any): string {
    if (!date) return '-';
    return this.datePipe.transform(date, 'dd/MM/yyyy') || '-';
  }
}
